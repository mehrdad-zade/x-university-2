# PostgreSQL Performance Configuration for X-University
# Optimized for development and production use with moderate load

# ==============================================
# CONNECTION AND AUTHENTICATION
# ==============================================
max_connections = 200                    # Increased for connection pooling
superuser_reserved_connections = 3

# ==============================================
# MEMORY CONFIGURATION
# ==============================================
# Adjust these based on available system memory
shared_buffers = 256MB                   # 25% of RAM for small systems
effective_cache_size = 1GB               # Available OS cache
work_mem = 4MB                          # Per-operation memory
maintenance_work_mem = 64MB              # VACUUM, CREATE INDEX memory
max_wal_size = 2GB                      # WAL checkpoint trigger
min_wal_size = 80MB                     # Minimum WAL size

# ==============================================
# QUERY PERFORMANCE 
# ==============================================
random_page_cost = 1.1                  # SSD-optimized (default 4.0 for HDDs)
effective_io_concurrency = 200          # SSD concurrent I/O
max_worker_processes = 8                # Parallel query workers
max_parallel_workers = 4                # Max parallel workers per query
max_parallel_workers_per_gather = 2     # Max parallel workers per node
max_parallel_maintenance_workers = 2    # VACUUM, CREATE INDEX parallelism

# ==============================================
# WRITE AHEAD LOG (WAL) OPTIMIZATION
# ==============================================
wal_level = replica                      # Enable replication
wal_sync_method = fdatasync             # Faster than fsync
checkpoint_timeout = 10min              # Checkpoint frequency
checkpoint_completion_target = 0.9      # Spread checkpoint I/O
wal_buffers = 16MB                      # WAL buffer size
wal_writer_delay = 200ms                # WAL writer flush frequency

# ==============================================
# AUTOVACUUM OPTIMIZATION
# ==============================================
autovacuum = on                         # Enable automatic maintenance
autovacuum_max_workers = 3              # Concurrent autovacuum processes
autovacuum_naptime = 20s                # Autovacuum frequency
autovacuum_vacuum_threshold = 50        # Min rows before vacuum
autovacuum_analyze_threshold = 50       # Min rows before analyze
autovacuum_vacuum_scale_factor = 0.1    # % of table before vacuum
autovacuum_analyze_scale_factor = 0.05  # % of table before analyze

# ==============================================
# LOGGING AND MONITORING
# ==============================================
log_destination = 'stderr'
logging_collector = on
log_filename = 'postgresql-%a.log'
log_truncate_on_rotation = on
log_rotation_age = 1d
log_rotation_size = 100MB

# Log slow queries for optimization
log_min_duration_statement = 1000       # Log queries > 1 second
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 10MB

# ==============================================
# STATISTICS AND QUERY PLANNING
# ==============================================
track_activities = on
track_counts = on
track_io_timing = on                    # Track I/O timing
track_functions = pl                    # Track function statistics
shared_preload_libraries = 'pg_stat_statements'  # Enable query statistics

# Query planner optimization
default_statistics_target = 100         # Histogram buckets for ANALYZE
constraint_exclusion = partition        # Partition pruning
enable_partitionwise_join = on          # Partition-wise joins
enable_partitionwise_aggregate = on     # Partition-wise aggregates

# ==============================================
# CONNECTION POOLING PREPARATION
# ==============================================
# These settings work well with connection poolers like PgBouncer
listen_addresses = '*'                  # Listen on all interfaces
port = 5432

# Tune for expected connection patterns
tcp_keepalives_idle = 600               # TCP keepalive (10 minutes)
tcp_keepalives_interval = 30            # TCP keepalive interval
tcp_keepalives_count = 3                # TCP keepalive retry count

# ==============================================
# DEVELOPMENT OPTIMIZATIONS
# ==============================================
# These can be adjusted for production
fsync = on                              # Keep on for data safety
synchronous_commit = on                 # Keep on for consistency
full_page_writes = on                   # Keep on for crash recovery

# Development convenience settings
log_statement = 'mod'                   # Log data modification statements
log_min_error_statement = error         # Log error statements
